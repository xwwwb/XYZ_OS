# XYZ OSğŸ§

æœ¬ä»“åº“è´Ÿè´£å­˜å‚¨éƒ‘å·è½»å·¥ä¸šå¤§å­¦è®¡ç®—æœºå­¦é™¢æ“ä½œç³»ç»Ÿè¯¾ç¨‹è®¾è®¡ä»£ç 

ğŸ¥³ æœ¬é¡¹ç›®å°†ä¾æ‰˜ã€Š30 å¤©è‡ªåˆ¶æ“ä½œç³»ç»Ÿã€‹ä»é›¶å¼€å§‹åˆ¶ä½œä¸€ä¸ªæ“ä½œç³»ç»Ÿ ğŸ‰

æœ¬æ–‡æ¡£**å®éªŒè¯¦æƒ…**éƒ¨åˆ†å°šæœªå®Œæˆï¼ï¼**å®ç°çš„æ–°åŠŸèƒ½**éƒ¨åˆ†å·²å®Œæˆï¼ï¼ï¼

è¿è¡Œæ–¹å¼ï¼š

ä»¥ä¸‹ä¸º Powershell ä½¿ç”¨ CMD æ—¶è‡ªè¡Œæ›¿æ¢æ–œæ 

```powershell
cd ./src/25_day
./make.bat run
```

æ—¥å¿—ï¼šæ—¥å¿—ä¸ºåˆæ¬¡è¯»ä¹¦çš„æ„Ÿå—ï¼Œå¾ˆå¤šç–‘æƒ‘åœ¨åå¤è¯»ä¹¦åå‡å·²è§£å†³

| ä¹¦æœ¬ç« èŠ‚ | è¿›åº¦      | å¤‡æ³¨                                                         | emoji |
| -------- | --------- | ------------------------------------------------------------ | ----- |
| day1     | 2023-5-28 | å¯ä»¥è°ƒç”¨æ˜¾å¡ BIOS ä¸­æ–­æ˜¾ç¤ºå­—ç¬¦                               | ğŸŠ     |
| day2     | 2023-5-28 | å‰ 512 å­—èŠ‚çš„ç£ç›˜æ–‡ä»¶ç”Ÿæˆå’Œå®Œæ•´é•œåƒç”Ÿæˆï¼Œmakefile æ–‡ä»¶å®Œå–„   | ğŸ’¾     |
| day3     | 2023-5-29 | C è¯­è¨€å¯¼å…¥ï¼Œä»ç£ç›˜è¯»å…¥ 10 ä¸ªæŸ±é¢                             | ğŸ¥²     |
| day4     | 2023-5-29 | å·²ç»å¯ä»¥åŸºæœ¬æ˜¾ç¤ºç”»é¢äº†ï¼Œé€æ¸æ„Ÿè§‰åˆ°æœ‰æ„æ€äº†                   | ğŸ¥³     |
| day5     | 2023-5-31 | äº†è§£äº†ç»“æ„ä½“çš„å†…å­˜åˆ†å¸ƒå’Œä½¿ç”¨ï¼Œæ–°å¢çš„ GDT å’Œ IDT éƒ¨åˆ†å¾ˆè¿·ç³Š   | ğŸ˜«     |
| day6     | 2023-5-31 | PIC ä¹Ÿå¾ˆè¿·ç³Šï¼Œä¸­æ–­å¤„ç†ç¨‹åºä½œç”¨æ˜¯ä¿æŠ¤ CPU ç°åœºï¼Œç»“åˆ day5 å¯ä»¥ç†è§£ä¸€ç‚¹ | ğŸ¤¨     |
| day7     | 2023-6-1  | ç†è§£äº† FIFO å…ˆè¿›å…ˆå‡ºçš„å®ç°ï¼Œå°†å…¶åº”ç”¨åœ¨å¤„ç†é”®ç›˜å’Œé¼ æ ‡çš„ä¸­æ–­å¤„ç†ä¸­ | ğŸ¥±     |
| day8     | 2023-6-1  | è§£æé¼ æ ‡ä¼ å…¥çš„ä¿¡å·ï¼Œè·å¾—ç‚¹å‡»å’Œç§»åŠ¨äº‹ä»¶ï¼Œä¿®æ”¹å›¾å½¢æ˜¾ç¤ºä»£ç ï¼Œå®ç°é¼ æ ‡çš„ç§»åŠ¨ | ğŸ¤©     |
| day9     | 2023-6-2  | ä½¿ç”¨è¯•æ¢çš„æ–¹å¼æ¢æµ‹å†…å­˜å¤§å°ï¼Œç¢°åˆ°äº†ç¼–è¯‘å™¨è¿‡ä¼˜åŒ–çš„é—®é¢˜ï¼Œä½¿ç”¨æ±‡ç¼–é‡å†™å‡½æ•°è§£å†³ | ğŸ«¡     |
| day10    | 2023-6-2  | è¿™ä¸€å¤©çš„ç®—æ³•æœ‰äº›éš¾ç†è§£ï¼Œä¸è¿‡ä¸æ€ä¹ˆæ¶‰åŠæ“ä½œç³»ç»Ÿï¼Œå¤§å¤šä¸ºå›¾å½¢å­¦ç®—æ³• | ğŸ“Š     |
| day11    | 2023-6-2  | è¿™ä¸€å¤©ä½¿ç”¨äº†å¤§é‡çš„ä¼˜åŒ–ç®—æ³•ï¼Œä¼˜åŒ–å›¾å½¢æ€§èƒ½ï¼Œç¬¬ä¸€æ¬¡çœ‹ä¸€å¤´é›¾æ°´ï¼Œå¤šçœ‹å‡ éæ‰å‹‰å¼ºç†è§£ | ğŸ˜«     |
| day12    | 2023-6-3  | ä½¿ç”¨äº†å¤–éƒ¨è®¾å¤‡å‘ç”Ÿä¸­æ–­çš„æ–¹å¼å®šæ—¶ï¼Œåé¢çš„ä¼˜åŒ–ç®—æ³•ï¼Œçœ‹çš„ä¹Ÿæ˜¯ä¸€å¤´é›¾æ°´ | â±ï¸     |
| day13    | 2023-6-3  | æœ€æœ€æœ€æœ€æ‡µé€¼çš„ä¸€å¤©ï¼Œé€è¡Œè¯»æœ‰äº›è¯»ä¸ä¸‹å»ï¼Œä¸ºäº†æ¨è¿›åº¦åªå¥½å…ˆå¼„æ‡‚æ˜¯åšä»€ä¹ˆçš„ | ğŸ’©     |
| day14    | 2023-6-3  | å†…å®¹è¾ƒä¸ºç®€å•ï¼Œå…ˆåˆ¤æ–­æ˜¾å¡æ”¯ä¸æ”¯æŒé«˜åˆ†ï¼Œæ”¯æŒåæ‰åˆ‡æ¢é«˜åˆ†       | ğŸ˜‹     |
| day15    | 2023-6-4  | ä½¿ç”¨äº† TSS æ®µå’Œ GDT å†…å­˜åˆ†æ®µåŠŸèƒ½å®ç°äº†å¤šä»»åŠ¡ï¼Œæ—¶é—´ç‰‡è½®è½¬     | ğŸ‘»     |
| day16    | 2023-6-4  | å°†ä»£ç æ•´åˆæˆ api çš„å½¢å¼ï¼ŒåŠ å…¥ä¼˜å…ˆçº§åŠŸèƒ½                      | âœˆï¸     |
| day17    | 2023-6-4  | æ•´ä½“éš¾åº¦ä¸å¤§ï¼Œåˆ©ç”¨å‰é¢æ­å»ºå¥½çš„å„ç§å‡½æ•°ï¼Œå³å¯ç»˜åˆ¶å‡ºæ§åˆ¶å°     | ğŸ’»     |
| day18    | 2023-6-5  | å¯¹æ§åˆ¶å°çª—å£åŠŸèƒ½è¿›è¡Œå‡çº§ï¼Œéš¾åº¦ä¸å¤§ï¼Œç„¶åè¯»å– FAT12 æ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯æè¿°å—ï¼Œæ‹¿åˆ°æ–‡ä»¶ä¿¡æ¯ | ğŸ’¾     |
| day19    | 2023-6-5  | ä¸»è¦ä¸ºéš¾åœ¨ FAT è¡¨ï¼Œæˆ‘æ··æ·†äº† FAT è¡¨å’Œæ–‡ä»¶ä¿¡æ¯æè¿°å—ï¼Œè¯¦æƒ…æŸ¥çœ‹å®éªŒè¯¦æƒ…ç¬¬ 19 å¤© | ğŸ“„     |
| day20    | 2023-6-6  | ä½¿ç”¨æ±‡ç¼–ç¼–å†™ api å‡½æ•°ï¼Œæ³¨å†Œè½¯ä¸­æ–­ï¼Œä½¿ç”¨ EDX å¯„å­˜å™¨ä¿å­˜åŠŸèƒ½ï¼Œåœ¨ GDT ä¸­æ³¨å†Œäº†ï¼Œä¸­æ–­å¤„ç†å‡½æ•° | ğŸ‘»     |
| day21    | 2023-6-6  | ä¸€å¤´é›¾æ°´ï¼Œå®Œå…¨æ²¡çœ‹æ‡‚ï¼Œä½†æ˜¯æ„Ÿè§‰å’Œæ¨è¿›è¿›åº¦æ— å…³ï¼Œå…ˆæ”¾ä¸€æ”¾       | ğŸ’©     |
| day22    | 2023-6-7  | ä½¿ç”¨ C è¯­è¨€ç¼–å†™å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šè¿‡è°ƒç”¨ç³»ç»Ÿ API çš„å½¢å¼å·¥ä½œ       | ğŸ¥³     |
| day23    | 2023-6-7  | æ–°åŠ å…¥å‡ ä¸ªå›¾å½¢ APIï¼Œä¸°å¯Œç³»ç»ŸåŠŸèƒ½                             | ğŸŒ     |
| day24    | 2023-6-7  | æ—¶é—´æœ‰äº›ç´§ï¼Œæ²¡ä»”ç»†çœ‹ï¼Œä½†æ˜¯è§‰å¾—ä¸å½±å“è¿›åº¦                     | ğŸ’©     |
| day25    | 2023-6-7  | æ—¶é—´æœ‰äº›ç´§ï¼Œæ²¡ä»”ç»†çœ‹ï¼Œä½†æ˜¯è§‰å¾—ä¸å½±å“è¿›åº¦                     | ğŸ’©     |
| æ–°åŠŸèƒ½   | 2023-6-8  | ä»¿ç…§ç³»ç»Ÿæä¾›çš„å¯æ‰§è¡Œç¨‹åºçš„å†™æ³•å’Œ API è°ƒç”¨çš„å†™æ³•ï¼Œè‡ªå·±åˆ›å»ºäº†å‡ ä¸ª APIï¼Œå®ç°ä¸€äº›æ–°åŠŸèƒ½ | ğŸ¥³     |

## é¡¹ç›®ç»“æ„

```
- src             # é¡¹ç›®ä»£ç 
  - 01_day
  - 02_day
  - 03_day
  ...
- README.md       # æ€»ä»‹ç»æ–‡ä»¶

- index.html      # web entry   ä¸ç”¨å…³å¿ƒ
- docs            # web code    ä¸ç”¨å…³å¿ƒ
- clang-format    # Cè¯­è¨€æ ¼å¼åŒ–å·¥å…·é…ç½®æ–‡ä»¶ è§„èŒƒä»£ç 
- .gitignore      # Gitå¿½ç•¥æ–‡ä»¶
- image_md        # å›¾ç‰‡å­˜å‚¨
```

## ç–‘é—®

- [x] ä¹¦æœ¬ P80-84 è°ƒè‰²æ¿éƒ¨åˆ†ä»£ç å°šæœªæŸ¥é˜…èµ„æ–™ç†è§£

  [ã€Š30 å¤©è‡ªåˆ¶æ“ä½œç³»ç»Ÿã€‹å­¦ä¹ ç¬”è®°â€”â€”ç¬¬å››å¤©\_è°ƒè‰²æ¿çš„è®¿é—®æ¨¡å¼\_cer_ml çš„åšå®¢-CSDN åšå®¢](https://blog.csdn.net/applenob/article/details/19134911)

  ä»¥åŠä¸ºä»€ä¹ˆè°ƒè‰²ç‰ˆä¸­ RGB é™¤ä»¥ 4ï¼š

  > åœ¨è¿™æ®µä»£ç ä¸­ï¼Œé€šè¿‡å‘ VGA æ˜¾ç¤ºå™¨çš„ 0x03c9 ç«¯å£å†™å…¥ RGB é¢œè‰²æ¥è®¾ç½®è°ƒè‰²æ¿ã€‚ç”±äº VGA æ˜¾ç¤ºå™¨ä½¿ç”¨ 6 ä½ï¼ˆ2^6=64ï¼‰æ¥è¡¨ç¤ºæ¯ä¸ªé¢œè‰²é€šé“çš„äº®åº¦å€¼ï¼Œå› æ­¤å°†æ¯ä¸ªé¢œè‰²é€šé“çš„å€¼é™¤ä»¥ 4 å¯ä»¥å°† 8 ä½ï¼ˆ2^8=256ï¼‰çš„é¢œè‰²èŒƒå›´ç¼©å°åˆ° 6 ä½çš„é¢œè‰²èŒƒå›´å†…ï¼Œå¹¶ä¸”ä¿ç•™äº†æ›´é«˜çš„ç°é˜¶çº§åˆ«ã€‚

- [x] ä¹¦æœ¬ P100 é¼ æ ‡èƒŒæ™¯æ˜¾ç¤ºå‡½æ•°çš„å®é™…æ„ä¹‰ï¼Ÿ

- [x] ä¹¦æœ¬ P113 LGDT çš„è®¡ç®—æ²¡çœ‹æ‡‚

  > ESP å¯„å­˜å™¨ ç¬¬å››ä½å¼€å§‹å­˜å‚¨ 0000ffff ç¬¬å…­ä½å­˜å‚¨ 00270000 ä»ç¬¬ 4 ä½å¼€å§‹è®¡ç®—
  >
  > FF FF 00 00 00 27 00 00
  >
  > 4 5 6 7 8 9 10 11
  >
  > è€Œ GDTR48 ä½å¯„å­˜å™¨ ä¹Ÿå°±æ˜¯ 6 å­—èŠ‚ ä½ 16 ä½æ˜¯æ®µä¸Šé™ å…¶ä½™ 32 ä½æ˜¯å¼€å§‹åœ°å€ å³æœ€åˆä¸¤ä¸ªå­—èŠ‚æ˜¯æ®µä¸Šé™å…¶ä½™å››ä¸ªå­—èŠ‚æ˜¯å¼€å§‹åœ°å€
  >
  > éœ€è¦çš„ç»“æœä¸º FF FF 00 27 00 00
  >
  > \_load_gdtr:
  >
  > MOV AX,[ESP+4]
  >
  > MOV [ESP+6],AX
  >
  > LGDT [ESP+6]
  >
  > RET
  >
  > ä»¥ä¸Šä»£ç  AX ä¸­å…ˆå­˜æ”¾ FF FF
  >
  > ç„¶åå°† FF FF æ”¾å…¥ ESP+6 æ­¤æ—¶ ESP ä¸º
  >
  > FF FF FF FF 00 27 00 00
  >
  > 4 5 6 7 8 9 10 11
  >
  > æ­¤æ—¶åœ¨è¯»å– ESP+6 å°±æ˜¯ FF FF 00 27 00 00

- [x] ä»£ç  day6 25 26 è¡Œæ²¡çœ‹æ‡‚

  > åœ¨ PIC ä¸Šæ‰“å¼€é”®ç›˜å’Œé¼ æ ‡çš„ä¸­æ–­

- [x] ä»£ç  æ±‡ç¼– OUT å’Œ IN æ˜¯æ€ä¹ˆå·¥ä½œçš„

  > å‘è®¾å¤‡ç«¯å£å†™å…¥å’Œè¯»å– æŸ¥è¡¨æ‰å¯ä»¥

- [x] ä¹¦æœ¬ day5-6 è¿˜æ˜¯ç”±å¾ˆå¤šç–‘é—® GDT IDT PIC ç­‰

  > æˆ‘ç†è§£ PIC ä¸ºå¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶ï¼Œåœ¨ IDT ä¸­æ³¨å†Œä¸­æ–­çš„å¤„ç†å‡½æ•°ï¼Œåœ¨ PIC ä¸­å¼€å¯ä¸­æ–­ï¼Œæ‰å¯ä»¥æ¥æ”¶åˆ°ä¸­æ–­
  >
  > æ³¨å†Œ IDT çš„æ—¶å€™ ä¼ å…¥çš„ 2 å°±æ˜¯ GDT ä¸­æ³¨å†Œè¿‡çš„ç¬¬äºŒæ®µï¼Œç¬¬äºŒæ®µå¥½åƒå­˜å‚¨ç€å½“å‰ C è¯­è¨€ç¼–è¯‘äº§ç‰©ï¼Œ2 _ 8 å°±æ˜¯æ®µåœ°å€ï¼Œç¬¬äºŒæ®µï¼Œä¼ å…¥çš„å‡½æ•°å°±æ˜¯åç§»åœ°å€ï¼Œå³ä¸­æ–­å¤„ç†ç¨‹åºå…¥å£ã€‚2 _ 8 æ˜¯å› ä¸ºæ®µé€‰æ‹©å™¨ç¬¬ä¸‰ä½å¿…é¡»ä¸º 0ï¼Œåº”è¯¥æ˜¯æƒé™ï¼Œ0 æ˜¯æœ€é«˜æƒé™
  >
  > IDT çš„å…·ä½“è¦æ±‚è¿˜ä¸æ˜¯å¾ˆäº†è§£ ä»¥åŠä¸ºä»€ä¹ˆ C è¯­è¨€ç¼–è¯‘äº§ç‰©åœ¨ç¬¬äºŒæ®µå†…å­˜ä¸­ äºŒæ®µçš„åœ°å€æ³¨å†Œä¸º 0x00280000 éš¾é“ C è¯­è¨€äº§ç‰©è¿è¡Œä¹Ÿä» 0x00280000 å¼€å§‹å—ï¼Ÿ
  >
  > è¯¾æœ¬ P157 è¯´äº†ç¡®å®æ˜¯è¿™æ · bootpack å¼€å§‹ 512 å¤åˆ¶åˆ°äº† 0x00280000ï¼Œæ‰€ä»¥ GDT çš„ç¬¬äºŒæ®µæ­£å¥½å°±æ˜¯å½“å‰ C è¯­è¨€äº§ç‰©çš„è¿è¡Œåœ°å€
  > #define LIMIT_GDT 0x0000ffff
  > #define ADR_BOTPAK 0x00280000
  > #define AR_DATA32_RW 0x4092
  > #define AR_CODE32_ER 0x409a
  >
  > set_segmdesc(gdt + 1, 0xffffffff, 0x00000000, AR_DATA32_RW); // ç³»ç»Ÿä¸“ç”¨ å¯è¯»å†™æ®µ ä¸å¯æ‰§è¡Œ
  >
  > set_segmdesc(gdt + 2, LIMIT_BOTPAK, ADR_BOTPAK, AR_CODE32_ER); // ç³»ç»Ÿä¸“ç”¨ï¼Œå¯æ‰§è¡Œæ®µï¼Œå¯è¯»ä¸å¯å†™
  >
  > æ®µ 2 çš„ä½œç”¨å°±æ˜¯å­˜æ”¾ bootpack çš„ä»£ç  bootpack ä»¥ ORG 0 ä¸ºå‰æç¿»è¯‘çš„
  >
  > æ®µ 1 æ˜¯ 4G CPU èƒ½ç®¡ç†çš„å…¨éƒ¨å†…å­˜ å…·ä½“ä½œç”¨è¿˜æœªçŸ¥

- [x] ä¹¦æœ¬ P123 DS ä¹Ÿå¥½ ES ä¹Ÿå¥½ SS ä¹Ÿå¥½ è¿™å¥è¯æ²¡çœ‹æ‡‚

  > **chatgpt**çš„å›ç­”ï¼šè¿˜æ˜¯ä¸€å¤´é›¾æ°´
  >
  > åœ¨å®æ¨¡å¼ä¸‹ï¼ŒCPU ä½¿ç”¨æ®µåœ°å€å’Œåç§»åœ°å€çš„æ–¹å¼æ¥è®¿é—®å†…å­˜ã€‚å½“ CPU æ‰§è¡ŒæŒ‡ä»¤æ—¶ï¼Œä¼šå°†æ®µåœ°å€å’Œåç§»åœ°å€åˆå¹¶æˆä¸€ä¸ªç‰©ç†åœ°å€ï¼Œä»¥è®¿é—®å†…å­˜ä¸­çš„æ•°æ®ã€‚
  >
  > åœ¨è¿™æ®µæ±‡ç¼–ä»£ç ä¸­ï¼Œå°† SSã€DS å’Œ ES å¯„å­˜å™¨éƒ½è®¾ç½®ä¸ºç›¸åŒçš„å€¼ï¼Œä¸»è¦æ˜¯ä¸ºäº†ä½¿å®ƒä»¬éƒ½æŒ‡å‘ç³»ç»Ÿçš„æ•°æ®æ®µï¼ˆdata segmentï¼‰ï¼Œä»è€Œèƒ½å¤Ÿåœ¨å…¶ä¸­æ­£ç¡®åœ°è®¿é—®å˜é‡å’Œæ•°æ®ç»“æ„ã€‚
  >
  > ç”±äºåœ¨å®æ¨¡å¼ä¸‹ï¼Œæ“ä½œç³»ç»Ÿåªèƒ½è®¿é—® 1MB çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œå› æ­¤å°† SSã€DS å’Œ ES å¯„å­˜å™¨éƒ½è®¾ç½®ä¸ºç›¸åŒçš„å€¼ä¹Ÿå¯ä»¥æœ€å¤§åŒ–åœ°åˆ©ç”¨å¯ç”¨çš„å†…å­˜ç©ºé—´ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ•ˆç‡ã€‚
  >
  > å¦å¤–ï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œä¸ºäº†æé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼ŒSSã€DS å’Œ ES å¯„å­˜å™¨çš„å€¼é€šå¸¸ä¼šåˆ†åˆ«æŒ‡å‘ä¸åŒçš„å†…å­˜æ®µï¼Œä»¥é¿å…ç¨‹åºæ„å¤–åœ°ä¿®æ”¹å…³é”®æ•°æ®ã€‚

- [x] ä¹¦æœ¬ day8 çš„é€šå¾€ 32 ä½æ¨¡å¼çš„è·³è½¬ä»£ç æ²¡çœ‹æ‡‚ ä½†æ˜¯ä¸å½±å“æ¥ä¸‹æ¥çš„å­¦ä¹ 

- [x] ç¬¬åå¤©çš„å åŠ å¤„ç†ï¼Œæœ€åçš„ä¼˜åŒ–ç®—æ³•æ²¡çœ‹æ‡‚ ä½†æ˜¯ä¸å½±å“æ¥ä¸‹æ¥çš„å­¦ä¹ 

- [x] ç¬¬åä¸€å¤©æ¶ˆé™¤é—ªçƒ æœ€åçš„ä¼˜åŒ–ç®—æ³•æ²¡ç†è§£é€å½» ä½†æ˜¯ä¸å½±å“æ¥ä¸‹æ¥çš„å­¦ä¹ 

- [x] ç¬¬åäºŒå¤©çš„åŠ å¿«ä¸­æ–­ç®—æ³• æ²¡æœ‰çœ‹çš„å¾ˆæ‡‚ å·²ç»å…¨éƒ¨çœ‹æ‡‚äº†

- [x] ç¬¬åä¸‰å¤©çš„ç®—æ³•

  > harib10h å› ä¸ºä¸­æ–­å¤„ç†ç¨‹åºä¸­å­˜åœ¨æ•°ç»„çš„ç§»ä½ï¼Œè¿™é‡Œæ¢äº†ç±»ä¼¼é“¾è¡¨çš„æ•°æ®ç»“æ„ é¿å…äº†ç§»ä½ åŠ å¿«äº†é€Ÿåº¦
  >
  > å…·ä½“ç®—æ³•æ²¡æœ‰æ·±ç©¶ï¼Œä¸å½±å“çœ‹ä¸‹å»
  >
  > å“¨å…µå®Œå…¨æ²¡çœ‹æ‡‚

- [x] ç¬¬åå…­å¤©ç®—æ³• æ²¡çœ‹æ‡‚

  > ä»»åŠ¡ç®¡ç†ï¼Œæ²¡æœ‰é€å¥è¯»ä»£ç 

- [x] å¤šä»»åŠ¡æ²¡çœ‹æ‡‚ ç¬¬ 17 å¤©çš„ä»£ç  å¤šä»»åŠ¡åˆ‡æ¢çš„æ—¶å€™ åº”è¯¥ä¸èƒ½å¤šæ¬¡æ‰§è¡Œ console_task çš„å§ï¼Œè¿™é‡Œé¢åŒ…æ‹¬äº†åˆå§‹åŒ–

  > æ˜¯ä¸æ˜¯å®é™…ä¸Šå¤šä»»åŠ¡æ˜¯è®°ä½äº†è¿è¡Œä½ç½® ç„¶åæ¥ç€è¿è¡Œä½ç½®ï¼Ÿ æ€ä¹ˆå®ç°çš„

- [x] cmdline è¿è¡Œå®Œä¸€ä¸ªç¨‹åºå å¦‚ä½•æ¸…ç©ºçš„

- [x] å¯¹ FAT æ”¯æŒè¿™é‡Œï¼Œä¸ºä»€ä¹ˆçªç„¶å‡ºç°äº†å‹ç¼©ç®—æ³•

  > FAT æ˜¯ FAT æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªè¡¨ ç”¨äºè®°å½•æ–‡ä»¶çš„é“¾æ¥ä½ç½® ä¹‹å‰çœ‹çš„é‚£äº›æ˜¯æ–‡ä»¶ä¿¡æ¯æè¿°è¡¨ FAT è¡¨å’Œæ–‡ä»¶ä¿¡æ¯æè¿°è¡¨ä¸åœ¨ä¸€ä¸ªä½ç½®

## å®ç°çš„æ–°åŠŸèƒ½

#### å³ä¸‹è§’æ—¶é’Ÿ

![åŠ¨ç”»](./image_md/%E5%8A%A8%E7%94%BB-1686246000192-2.gif)

ç»è¿‡æŸ¥é˜…èµ„æ–™å¯å¾—åˆ°è·å– CMOS ä¿¡æ¯çš„å¸¸é‡

ç¼–å†™å¦‚ä¸‹ä»£ç æ‹¿åˆ°æ—¶é—´

```C
// cmos.c
#include "bootpack.h"

unsigned char read_cmos(unsigned char p) {
    unsigned char data;
    io_out8(cmos_index, p);
    data = io_in8(cmos_data);
    io_out8(cmos_index, 0x80);
    return data;
}
unsigned int get_hour_hex() {
    return BCD_HEX(read_cmos(CMOS_CUR_HOUR));
}
unsigned int get_min_hex() {
    return BCD_HEX(read_cmos(CMOS_CUR_MIN));
}
unsigned int get_sec_hex() {
    return BCD_HEX(read_cmos(CMOS_CUR_SEC));
}
unsigned int get_day_of_month() {
    return BCD_HEX(read_cmos(CMOS_MON_DAY));
}
unsigned int get_day_of_week() {
    return BCD_HEX(read_cmos(CMOS_WEEK_DAY));
}
unsigned int get_mon_hex() {
    return BCD_HEX(read_cmos(CMOS_CUR_MON));
}
unsigned int get_year() {
    return (BCD_HEX(read_cmos(CMOS_CUR_CEN)) * 100) + BCD_HEX(read_cmos(CMOS_CUR_YEAR)) - 30 + 2010;
}
```

```C
/**CMOSæ“ä½œç«¯å£**/
#define cmos_index 0x70
#define cmos_data 0x71
/**CMOSä¸­ç›¸å…³ä¿¡æ¯åç§»*/
#define CMOS_CUR_SEC 0x0  // CMOSä¸­å½“å‰ç§’å€¼(BCD)
#define CMOS_ALA_SEC 0x1  // CMOSä¸­æŠ¥è­¦ç§’å€¼(BCD)
#define CMOS_CUR_MIN 0x2  // CMOSä¸­å½“å‰åˆ†é’Ÿ(BCD)
#define CMOS_ALA_MIN 0x3  // CMOSä¸­æŠ¥è­¦åˆ†é’Ÿ(BCD)
#define CMOS_CUR_HOUR 0x4 // CMOSä¸­å½“å‰å°æ—¶(BCD)
#define CMOS_ALA_HOUR 0x5 // CMOSä¸­æŠ¥è­¦å°æ—¶(BCD)
#define CMOS_WEEK_DAY 0x6 // CMOSä¸­ä¸€å‘¨ä¸­å½“å‰å¤©(BCD)
#define CMOS_MON_DAY 0x7  // CMOSä¸­ä¸€æœˆä¸­å½“å‰æ—¥(BCD)
#define CMOS_CUR_MON 0x8  // CMOSä¸­å½“å‰æœˆä»½(BCD)
#define CMOS_CUR_YEAR 0x9 // CMOSä¸­å½“å‰å¹´ä»½(BCD)
#define CMOS_DEV_TYPE 0x12// CMOSä¸­é©±åŠ¨å™¨æ ¼å¼
#define CMOS_CUR_CEN 0x32 // CMOSä¸­å½“å‰ä¸–çºª(BCD)

#define BCD_HEX(n) ((n >> 4) * 10) + (n & 0xf)// BCDè½¬16è¿›åˆ¶

#define BCD_ASCII_first(n) (((n << 4) >> 4) + 0x30)// å–BCçš„ä¸ªä½å¹¶ä»¥å­—ç¬¦è¾“å‡º,æ¥è‡ªUdoOS
#define BCD_ASCII_S(n) ((n << 4) + 0x30)           // å–BCDçš„åä½å¹¶ä»¥å­—ç¬¦è¾“å‡º,æ¥è‡ªUdoOS

unsigned int get_hour_hex();
unsigned int get_min_hex();
unsigned int get_sec_hex();
unsigned int get_day_of_month();
unsigned int get_day_of_week();
unsigned int get_mon_hex();
unsigned int get_year();
```

æ­¤ä»£ç è¿è¡Œåœ¨å®šæ—¶å™¨ä¸­ åˆ·æ–°æ—¶é—´

```C
// bootpack.c
sprintf(s, "%d-%02d-%02d %02d:%02d:%02d", get_year(), get_mon_hex(), get_day_of_month(), get_hour_hex(), get_min_hex(), get_sec_hex());

putfonts8_asc_sht(sht_back, binfo->scrnx - 160, binfo->scrny - 20, COL8_000000, COL8_C6C6C6, s, 19);

sheet_refresh(sht_back, binfo->scrnx - 160, binfo->scrny - 20,
              binfo->scrnx - 45 + 5 * 8, binfo->scrny - 50 + 16);
```

#### è¯»å–æ—¶é—´çš„ API

æ³¨å†Œ api ä» 30 å·å¼€å§‹ç¼–å· è¿è¡Œæ—¶è§¦å‘è½¯ä¸­æ–­

```assembly
// a_nask.nas
_api_getsecond:		; int api_getsecond(void);
   		PUSH	EBX
		MOV		EDX,30
		INT		0x40
		POP		EBX
		RET

_api_getminute:		; int api_getminute(void);
		PUSH	EBX
		MOV		EDX,31
		INT		0x40
		POP		EBX
		RET

_api_gethour:		; int api_gethour(void);
		PUSH	EBX
		MOV		EDX,32
		INT		0x40
		POP		EBX
		RET

_api_getyear:		; int api_getyear(void);
		PUSH	EBX
		MOV		EDX,33
		INT		0x40
		POP		EBX
		RET

_api_getmonth:		; int api_getmonth(void);
		PUSH	EBX
		MOV		EDX,34
		INT		0x40
		POP		EBX
		RET

_api_getday:		; int api_getday(void);
		PUSH	EBX
		MOV		EDX,35
		INT		0x40
		POP		EBX
		RET
```

ä¸­æ–­å¤„ç†å‡½æ•°

```C
// console.c
else if (edx == 30) {
        reg[7] = get_sec_hex();
    }
    else if (edx == 31) {
        reg[7] = get_min_hex();
    }
    else if (edx == 32) {
        reg[7] = get_hour_hex();
    }
    else if (edx == 33) {
        reg[7] = get_year();
    }
    else if (edx == 34) {
        reg[7] = get_mon_hex();
    }
    else if (edx == 35) {
        reg[7] = get_day_of_month();
}
```

#### ç”»åœ† API

æ³¨å†Œ edx ä¸º 40 å·çš„ api

```assembly
_api_drawcircle:	; void api_drawcircle(int win, int x, int y, int r, int nouse, int col);
		PUSH	EDI
		PUSH	ESI
		PUSH	EBP
		PUSH	EBX
		MOV		EDX,40
		MOV		EBX,[ESP+20]	; win
		MOV		EAX,[ESP+24]	; x
		MOV		ECX,[ESP+28]	; y
		MOV		ESI,[ESP+32]	; r
		MOV		EDI,[ESP+36]	; nouse
		MOV		EBP,[ESP+40]	; col
		INT		0x40
		POP		EBX
		POP		EBP
		POP		ESI
		POP		EDI
		RET
```

æ¥å—å®Œå‚æ•°åè°ƒç”¨ä½äº graphic.c çš„ç»˜åˆ¶å›¾åƒå‡½æ•°

```C
// console.c
else if (edx == 40) {
        sht = (struct SHEET *) (ebx & 0xfffffffe);
        int x = eax, y = ecx, r = esi;
        int color = ebp;
        drawcircle(sht->buf, x, y, r, color, sht->bxsize);
        if ((ebx & 1) == 0) {
            sheet_refresh(sht, x + r, y + r, x - r, y - r);
        }
}
```

ä½¿ç”¨è®¡ç®—æœºå›¾å½¢å­¦ä¸­çš„ bresenham ç®—æ³•ç»˜åˆ¶å›¾åƒ

```C
// graphic.c
void drawFullCircle(int x0, int y0, int x, int y, int color, int xsize, char *vram) {
    int circle_x = x0;
    int circle_y = y0;
    vram[(circle_y + y) * xsize + (circle_x + x)] = color;
    vram[(circle_y + y) * xsize + (circle_x - x)] = color;
    vram[(circle_y - y) * xsize + (circle_x + x)] = color;
    vram[(circle_y - y) * xsize + (circle_x - x)] = color;
    vram[(circle_y + x) * xsize + (circle_x + y)] = color;
    vram[(circle_y + x) * xsize + (circle_x - y)] = color;
    vram[(circle_y - x) * xsize + (circle_x + y)] = color;
    vram[(circle_y - x) * xsize + (circle_x - y)] = color;
}
void drawcircle(char *vram, int x0, int y0, int r0, unsigned char c, int xsize) {
    int x = 0;
    int y = r0;
    int d = 1 - y;
    int color = c;
    while (x < y) {
        drawFullCircle(x0, y0, x, y, color, xsize, vram);
        if (d < 0) {
            d = d + 2 * x + 3;
        }
        else {
            d = d + 2 * (x - y) + 5;
            y = y - 1;
        }
        x = x + 1;
    }
}
```

æ•ˆæœï¼š

![image-20230609015254218](./image_md/image-20230609015254218.png)

#### æ¨¡æ‹Ÿæ—¶é’Ÿ

ç»“åˆä»¥ä¸Šå·¥ä½œ

åˆ¶ä½œæ¨¡æ‹Ÿæ—¶é’Ÿ

ä½¿ç”¨ç”»åœ† API ç»˜åˆ¶è¡¨ç›˜ è¯»å–æ—¶é—´çš„ API æ‹¿åˆ°æ—¶é—´ ç„¶åä½¿ç”¨ç»˜åˆ¶ç›´çº¿çš„ API ç»˜åˆ¶æŒ‡é’ˆ

ç»˜åˆ¶æ–‡å­—çš„ API ç»˜åˆ¶æ—¶åˆ»

```C
#include <math.h>
#include <stdio.h>
int api_openwin(char *buf, int xsiz, int ysiz, int col_inv, char *title);
void api_initmalloc(void);
char *api_malloc(int size);
void api_refreshwin(int win, int x0, int y0, int x1, int y1);
void api_linewin(int win, int x0, int y0, int x1, int y1, int col);
void api_closewin(int win);
int api_getkey(int mode);
void api_end(void);
void api_putstrwin(int win, int x, int y, int col, int len, char *str);
int api_getsecond(void);
int api_getminute(void);
int api_gethour(void);
int ap_getyear(void);
int api_getmonth(void);
int api_getday(void);
void api_drawcircle(int win, int x, int y, int r, int nouse, int col);
int api_alloctimer(void);
void api_inittimer(int timer, int data);
void api_settimer(int timer, int time);
void api_boxfilwin(int win, int x0, int y0, int x1, int y1, int col);

double M_PI = 3.14;
HariMain(void) {
    char *buf;
    int win, i;
    api_initmalloc();
    buf = api_malloc(160 * 180);
    win = api_openwin(buf, 160, 180, -1, "CLOCK");
    static int label_m[60][2] = {
        // å†…å®¹å¤ªé•¿ è¯·ç›´æ¥é˜…è¯»ä»£ç 
    };
    static int label_h[12][2] = {
        // å†…å®¹å¤ªé•¿ è¯·ç›´æ¥é˜…è¯»ä»£ç 
    };
    static int label_text[12][2] = {
        // å†…å®¹å¤ªé•¿ è¯·ç›´æ¥é˜…è¯»ä»£ç 
    };
    int timer;
    timer = api_alloctimer();
    api_inittimer(timer, 128);
    char *s;
    int sec = 0, min = 0, hou = 0;

    sec = api_getsecond();
    min = api_getminute();
    hou = api_gethour();
    api_boxfilwin(win + 1, 80 - 65, 93 - 65, 80 + 65, 93 + 65, 8);
    // åœ†å¿ƒæ˜¯80,93ï¼ŒåŠå¾„æ˜¯65 è¡¨ç›˜
    api_drawcircle(win, 80, 93, 65, 0, 15);
    api_linewin(win + 1, 80, 93, label_m[min][0], label_m[min][1], 0);
    api_linewin(win + 1, 80, 93, label_h[hou % 12][0], label_h[hou % 12][1], 0);
    api_linewin(win + 1, 80, 93, label_m[sec][0], label_m[sec][1], 1);
    int dx = -5, dy = -6;
    for (;;) {
        // æ¸…é™¤åŸæœ¬
        api_boxfilwin(win + 1, 80 - 65, 93 - 65, 80 + 65, 93 + 65, 8);
        // åœ†å¿ƒæ˜¯80,93ï¼ŒåŠå¾„æ˜¯65 è¡¨ç›˜
        api_drawcircle(win, 80, 93, 65, 0, 15);
        int i;
        for (i = 0; i < 12; i++) {
            char s[2] = {0};
            int j = (i + 12) % 12;
            if (j == 0) j = 12;
            sprintf(s, "%d", j);
            api_putstrwin(win + 1, label_text[i][0] + dx, label_text[i][1] + dy, 0, 2, s);
        }
        api_linewin(win + 1, 80, 93, label_m[min][0], label_m[min][1], 0);
        api_linewin(win + 1, 80, 93, label_h[hou % 12][0], label_h[hou % 12][1], 0);
        api_linewin(win + 1, 80, 93, label_m[sec][0], label_m[sec][1], 1);

        api_refreshwin(win, 0, 0, 160, 180);

        api_settimer(timer, 100); /* 1ç§’ */
        if (api_getkey(1) != 128) {
            break;
        }
        sec = api_getsecond();
        min = api_getminute();
        hou = api_gethour();
    }
    api_closewin(win);
    api_end();
}

```

å€¼å¾—æ³¨æ„çš„æ˜¯ ç¨‹åºä¸­åŒ…å«ä¸‰ä¸ªäºŒç»´æ•°ç»„

è¿™ä¸‰ä¸ªæ•°ç»„åˆ†åˆ«è®°å½•ç€

å¤§åˆ»åº¦ 12 0 1 2 3 4 5 6 7 8 9 10 11

å°åˆ»åº¦ 0-60

æ–‡å­—åˆ»åº¦ 12 0 1 2 3 4 5 6 7 8 9 10 11

è¿™äº›åˆ»åº¦çš„åœ¨çª—å£ä¸­çš„åæ ‡ å› ä¸ºç›´æ¥ä½¿ç”¨ math.h è®¡ç®—ä¼šå‡ºç°æœªçŸ¥é”™è¯¯ è¿™é‡Œæˆ‘ä½¿ç”¨ python è®¡ç®—å¥½å…¨éƒ¨çš„åˆ»åº¦å€¼ æ”¾å…¥

ä¸‰ä¸ªæ•°ç»„ä¸­å³å¯ï¼š

```python
# ç”¨äºè®¡ç®—é’Ÿè¡¨ä¸Šå„ä¸ªåˆ»åº¦çš„åæ ‡
import math
r = 55
for i in range(0, 12):
    # 60ä¸ªåˆ»åº¦çš„åæ ‡
    x = 80 + r * math.sin(math.pi / 180 * i * 30)
    y = 93 - r * math.cos(math.pi / 180 * i * 30)
    # è¾“å‡ºä¸º {x,y}, çš„å½¢å¼
    print("{%d,%d}," % (x, y))
```

æœ€ç»ˆå®ç°æ¨¡æ‹Ÿæ—¶é’Ÿ

![clock](./image_md/clock.gif)

#### å¼€æœºåŠ¨ç”»

è¿™é‡Œé¡½çš®ä¸€ä¸‹ å…¶å®å°±æ˜¯ä¸ºäº†åŠ å…¥è€ŒåŠ å…¥

ä¿®æ”¹äº†ä¸¤éƒ¨åˆ†

åœ¨è¯»å–å®Œæ‰€æœ‰æŸ±é¢å è¾“å‡º welcome ä¸­çš„æ–‡å­— ç„¶åæ‰§è¡Œ HLT çš„å¾ªç¯åˆ° 0x8F åè·³å…¥åˆ°å¯åŠ¨ç¨‹åº

<img src="./image_md/image-20230609020412993.png" alt="image-20230609020412993" style="zoom:50%;" />

åœ¨ C è¯­è¨€å…¥å£æ–‡ä»¶ wait_a_while æ˜¯æ±‡ç¼–å†™çš„å‡½æ•°ä½œç”¨æ˜¯æ‰§è¡Œ 50 ä¸ª HLT

```C
void HariMain(void) {
    struct BOOTINFO *binfo = (struct BOOTINFO *) ADR_BOOTINFO;
    bootcover(binfo, 0);
    wait_a_while();
    bootcover(binfo, 1);
    wait_a_while();
    bootcover(binfo, 2);
    wait_a_while();
    wait_a_while();
    bootcover(binfo, 3);
    wait_a_while();
    wait_a_while();
    wait_a_while();
    bootcover(binfo, 4);
    ....
}
```

bootcover.c ä¸­ç®€å•çš„å›¾å½¢ç»˜åˆ¶

```C
#include "bootpack.h"
void setColor(int x, int y, int color, int xsize, int ysize, char *vram) {
    if (x < 0 || x >= xsize || y < 0 || y >= ysize) {
        return;
    }
    char *p = vram + y * xsize + x;

    *p = color;
}
void bootcover(struct BOOTINFO *binfo, int step) {
    int xsize = binfo->scrnx, ysize = binfo->scrny;
    int i, j;
    int color = 15;
    if (step == 0) {
        for (i = 0; i < xsize; i++) {
            for (j = 0; j < ysize; j++) {
                setColor(i, j, color, xsize, ysize, binfo->vram);
            }
        }
    }
    // ç»˜åˆ¶çŸ©å½¢
    int width, height = 40;
    int x = 0, y = binfo->scrny / 2 - height / 2;
    if (step == 0) {
        width = binfo->scrnx / 4 * 1;
    }
    else if (step == 1) {
        width = binfo->scrnx / 4 * 2;
    }
    else if (step == 2) {
        width = binfo->scrnx / 4 * 3;
    }
    else if (step == 3) {
        width = binfo->scrnx - 1;
    }
    else {
        color = 0;
        for (i = 0; i < xsize; i++) {
            for (j = 0; j < ysize; j++) {
                setColor(i, j, color, xsize, ysize, binfo->vram);
            }
        }
        return;
    }
    for (i = 0; i < width; i++) {
        for (j = 0; j < height; j++) {
            setColor(x + i, y + j, 1, xsize, ysize, binfo->vram);
        }
    }
    return;
}
```

æ•ˆæœ

![an](./image_md/an.gif)

#### å…³æœº é‡å¯

ä»¥ä¸‹ä»£ç æ˜¯ä»ç½‘ä¸Šæ”¶é›†æ¥çš„ï¼Œä¸æ˜¯å¾ˆç†è§£

```assembly
; [BITS32]
_shutdown:
JMP start2
db 0x00, 0x00
protect16:
db 0xb8, 0x08, 0x00, 0x8e, 0xd8, 0x8e, 0xc0, 0x8e, 0xd0
db 0x0f, 0x20, 0xc0, 0x66, 0x25, 0xfe,0xff,0xff, 0x7f
db 0x0f, 0x22, 0xc0
db 0xea
dw 0x0650,0x0000
ALIGNB 16
protect16_len EQU $ - protect16
;ä¸Šé¢çš„ä»£ç ä¸º16ä½ä¿æŠ¤æ¨¡å¼è·³å…¥å®æ¨¡å¼åŠŸèƒ½ä»£ç 
;ä¿æŠ¤æ¨¡å¼ä»£ç ä¼ é€åˆ°å†…å­˜0x0630å¤„ï¼Œä¸ºå®ƒä¿ç•™0x20 B

realmod:
db 0x8c, 0xc8
db 0x8e, 0xd8
db 0x8e, 0xc0
db 0x8e, 0xd0
db 0xbc, 0x00, 0x08
db 0xe4, 0x92
db 0x24, 0xfd
db 0xe6, 0x92
db 0x90, 0x90, 0x90
db 0xfb, 0x90
db 0xb8, 0x03, 0x00
db 0xcd, 0x10
;db 0xf4 ;å…³æœº
db 0xb8, 0x07, 0x53
db 0xbb, 0x01, 0x00
db 0xb9, 0x03, 0x00
db 0xcd, 0x15
ALIGNB 16
realmod_len EQU $ - realmod
; ä»¥ä¸Šä»£ç æ®µä¸ºå®æ¨¡å¼ä¸‹è®¾ç½®å­—ç¬¦æ˜¾ç¤ºæ¨¡å¼åŠå…³æœºä»£ç 
; å®æ¨¡å¼åŠŸèƒ½ä»£ç ä¼ é€åˆ°0x0650å¤„ã€‚

GDTIDT:
dw 0x0000, 0x0000, 0x0000, 0x0000
dw 0xffff, 0x0000, 0x9200, 0x0000
dw 0xffff, 0x0000, 0x9800, 0x0000
dw 0x0000
dw 0x0017
dw 0x0600, 0x0000
dw 0x03ff
dw 0x0000, 0x0000
ALIGNB 16
GDTIDT_lenth EQU $ - GDTIDT
;ä»¥ä¸Šä¸ºGDTåŠITDè¡¨é¡¹æ•°æ®
;ä»¥ä¸Šæ•°æ®ä¼ é€åˆ°0x0600å¤„ï¼Œä¿ç•™0x30 Bçš„ç©ºé—´ã€‚

start2:
MOV EBX, GDTIDT
MOV EDX, 0x600
MOV CX, GDTIDT_lenth
.loop1:
MOV AL, [CS:EBX]
MOV [EDX], AL
INC EBX
INC EDX
loop .loop1

MOV EBX, protect16
MOV EDX, 0x630
MOV CX, protect16_len
.loop2:
MOV AL, [CS:EBX]
MOV [EDX], AL
INC EBX
INC EDX
loop .loop2

MOV EBX, realmod
MOV EDX, 0x650
MOV CX, realmod_len
.loop3:
MOV AL, [CS:EBX]
MOV [EDX], AL
INC EBX
INC EDX
loop .loop3

LGDT [0x061A]
LIDT [0x0620]
JMP 2*8:0x0630

_reboot:
mov al,0feh
out 64h,al
```

æ•ˆæœï¼š![shutdown](./image_md/shutdown.gif)

#### ä½¿ç”¨ Python ç¼–å†™åˆ¶ä½œé¼ æ ‡æŒ‡é’ˆçš„ç¨‹åº

æ­¤åŠŸèƒ½ä¸ºé¢å¤–åŠŸèƒ½

ä½¿ç”¨ opencv å¤„ç†å›¾ç‰‡ å›¾ç‰‡è½¬ä¸ºç°åº¦å›¾ ç„¶åæ ¹æ®è®¾ç½®çš„é˜ˆå€¼è½¬ä¸ºäºŒå€¼å›¾ ç„¶åè½¬ä¸ºå­—ç¬¦ä¸²å½¢å¼

```python
import cv2 as cv

# æ‰“å¼€å›¾ç‰‡
img = cv.imread("mouse.png")
# å›¾ç‰‡ç¼©æ”¾16*16
img = cv.resize(img, (16, 16))
gray = cv.cvtColor(img, cv.COLOR_BGR2GRAY)
ret, binary = cv.threshold(gray, 150, 255, cv.THRESH_BINARY)
# ä¿å­˜ä¸º16*16å­—ç¬¦ä¸² äº®è‰²ç”¨ . è¡¨ç¤ºï¼Œæš—è‰²ç”¨ O è¡¨ç¤º
for i in range(16):
    print("\"", end="")
    for j in range(16):
        if binary[i, j] == 255:
            print(".", end="")
        else:
            print("O", end="")
    print("\",")

```

ä¼ å…¥å›¾ç‰‡ï¼š

<img src="./image_md/image-20230609020939392.png" alt="image-20230609020939392" style="zoom:25%;" />

å¾—åˆ°æ•ˆæœï¼š

<img src="./image_md/image-20230609021005358.png" alt="image-20230609021005358" style="zoom:50%;" />

è¿è¡Œæ•ˆæœï¼š

![image-20230609021030159](./image_md/image-20230609021030159.png)

#### è°ƒèŠ‚é¼ æ ‡é€Ÿåº¦çš„ç¨‹åº

åœ¨é¼ æ ‡ç§»åŠ¨æ—¶ ç»™ä½ç§»å‚æ•°ä¹˜ä¸Šç¼©æ”¾æ¯”ä¾‹

ä¿®æ”¹å¤´æ–‡ä»¶ä¸­çš„ MOUSE_DEC åŠ å…¥ scale

```C
struct MOUSE_DEC {
    unsigned char buf[3], phase;
    int x, y, btn;
    int scale;
};
```

ä¸»å‡½æ•°ä¸­ä¹˜ç³»æ•° ç¬¬äº”è¡Œçš„å‡½æ•°ç”¨äºæ˜¾ç¤ºå­—ä½“ä½†æ˜¯ä½¿ç”¨ rgb èƒŒæ™¯è‰² è¯¦æƒ…çœ‹ ä¸»é¢˜æ›´æ¢ èŠ‚

```c
mx += mdec.x * mdec.scale;
my += mdec.y * mdec.scale;
char *text;
sprintf(text, "Press the middle key to increase mouse speed:%d", mdec.scale);
putfonts8_asc_sht_rgbbk(sht_back, 0, 200, COL8_FFFFFF, text, 60, 51, 65, 85);
```

é¼ æ ‡å¤„ç†éƒ¨åˆ† æŒ‰ä¸‹ä¸­é”®ä¿®æ”¹é€Ÿåº¦

```c
// æŒ‰ä¸‹ä¸­é”®
if ((mdec.btn & 0x04) != 0) {
    if (mdec.scale == 10) {
        mdec.scale = 1;
    }
    else {
        mdec.scale += 1;
    }
}
```

æ•ˆæœ

![mouse](./image_md/mouse.gif)

#### ä¸­æ–‡æ”¯æŒ

ä½¿ç”¨[ç‚¹é˜µå­—ç¬¦åœ¨çº¿ç”Ÿæˆï¼Œç‚¹é˜µå­—ä»£ç ç”Ÿæˆå™¨ (qqxiuzi.cn)](https://www.qqxiuzi.cn/zh/dianzhenzi-zifu/)

ç”Ÿæˆç‚¹é˜µ ä¿®æ”¹æ ¼å¼åå­˜å…¥ font_x æ•°ç»„ä¸­ ä½¿ç”¨ putfont16 ç»˜åˆ¶

![image-20230608173442051](./image_md/image-20230608173442051.png)![image-20230609021615019](./image_md/image-20230609021615019.png)

```C
// graphic.c
void putfont16(char *vram, int xsize, int x, int y, char c, char font[16][16]) {
    // ä¼ å…¥fontæ˜¯16*16çš„æ•°ç»„
    int i, j;
    char *p, d /* data */;
    for (i = 0; i < 16; i++) {
        for (j = 0; j < 16; j++) {
            p = vram + (y + i) * xsize + x + j;
            d = font[i][j];
            if (d == '1') {
                p[0] = c;
            }
        }
    }
    return;
}

static char font_1[16][16] = {
    "0000000000000000",
    "0100001100000000",
    "0110011001111110",
    "0011010001111110",
    "1111111101100110",
    "1111111101100110",
    "0001100001101100",
    "0001100001101000",
    "1111111101101100",
    "1111111101100110",
    "0001100001100110",
    "0001110001100110",
    "0011011001111110",
    "0110001101101100",
    "1100000101100000",
    "1000000001100000",
};
```

#### ä¸»é¢˜æ›´æ¢

åˆ›å»ºä½¿ç”¨ RGB åšè‰²å½©çš„ç›¸å…³å‡½æ•°

```C
unsigned char rgb2pal(int r, int g, int b, int x, int y) {
    static int table[4] = {3, 1, 0, 2};
    int i;
    x &= 1; /*åˆ¤æ–­æ˜¯å¶æ•°è¿˜æ˜¯å¥‡æ•°*/
    y &= 1;
    i = table[x + y * 2]; /*ç”¨æ¥ç”Ÿæˆä¸­é—´è‰²çš„å¸¸é‡*/
    r = (r * 21) / 256;   /* rä¸º0ï½20*/
    g = (g * 21) / 256;
    b = (b * 21) / 256;
    r = (r + i) / 4; /* rä¸º0ï½5*/
    g = (g + i) / 4;
    b = (b + i) / 4;
    return 16 + r + g * 6 + b * 36;
}


void boxfillrgb(unsigned char *vram, int xsize, int x0, int y0, int x1, int y1, int r, int g, int b) {
    int x, y;
    for (y = y0; y <= y1; y++) {
        for (x = x0; x <= x1; x++) { vram[y * xsize + x] = rgb2pal(r, g, b, x, y); }
    }
    return;
}
void putfonts8_asc_sht_rgbbk(struct SHEET *sht, int x, int y, int c, char *s, int l, int r, int g, int b) {
    boxfillrgb(sht->buf, sht->bxsize, x, y, x + l * 8 - 1, y + 15, r, g, b);
    putfonts8_asc(sht->buf, sht->bxsize, x, y, c, s);
    sheet_refresh(sht, x, y, x + l * 8, y + 16);
    return;
}
```

æ•ˆæœï¼ŒèƒŒæ™¯è‰²ä¸º(51, 65, 85)

![image-20230609021840077](./image_md/image-20230609021840077.png)

## å®éªŒè¯¦æƒ…

### ç¬¬ä¸€å¤©

<img src="./image_md/image-20230529210641118.png" alt="image-20230529210641118" style="zoom:50%;" />

### ç¬¬äºŒå¤©

å’Œç¬¬ä¸€å¤©çš„è¿è¡Œç»“æœä¸€è‡´ï¼š

<img src="./image_md/image-20230529210847550.png" alt="image-20230529210847550" style="zoom:80%;" />

é™„ä¸Š VMware çš„è¿è¡Œç»“æœå’Œè£¸æœºè¿è¡Œç»“æœ

<img src="./image_md/image-20230529211029376.png" alt="image-20230529211029376" style="zoom:80%;" />

<img src="./image_md/image-20230529211606790.png" alt="image-20230529211606790" style="zoom:80%;" />

### ç¬¬ä¸‰å¤©

å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªé»‘è‰²çš„ç”»é¢

 <img src="./image_md/image-20230529211242634.png" alt="image-20230529211242634" style="zoom:80%;" />

### ç¬¬å››å¤©

C è¯­è¨€æ±‡ç¼–æ··åˆç¼–ç¨‹ æ±‡ç¼–å®ç°äº†å‡ ä¸ªå‡½æ•°

è¿™é‡Œä¸¤ä¸ªå®éªŒç»“æœ ä½¿ç”¨ makefile çš„å˜é‡åˆ‡æ¢ç¼–è¯‘çš„æ–‡ä»¶

ä¸€ä¸ªæ˜¯ç»“åˆäº†è®¡ç®—æœºå›¾å½¢å­¦çš„ç®€å•ç®—æ³•ç»˜åˆ¶å›¾åƒ ç›´æ¥è¯»å†™æ˜¾å­˜

ä¸€ä¸ªæ˜¯ä¹¦æœ¬çš„è¿è¡Œç»“æœ

<img src="./image_md/image-20230529211428060.png" alt="image-20230529211428060" style="zoom:80%;" />

<img src="./image_md/image-20230529211749295.png" alt="image-20230529211749295" style="zoom:80%;" />

### ç¬¬äº”å¤©

ç»“æ„ä½“åœ¨å†…å­˜ä¸­é¡ºåºå­˜å‚¨ï¼Œç»“æ„ä½“æŒ‡é’ˆæŒ‡å‘ç»“æ„ä½“çš„é¦–åœ°å€ï¼Œç»“æ„ä½“å„ä¸ªå…ƒç´ éƒ½å¯ä»¥æŒ‰é¡ºåºç”¨ç®­å¤´è®¿é—®åˆ°

ç„¶åä½¿ç”¨äº†å­—ç¬¦ç‚¹é˜µçš„å½¢å¼è¡¨ç¤ºå•ä¸ªå­—ç¬¦ï¼Œè¿™é‡Œå¯¹ä»¥ä¸‹è¾“å‡ºç®—æ³•åšä¸ªç®€å•çš„ä¾‹å­

```C
int main(){
    static char font_A[16] = {
		0x00, 0x18, 0x18, 0x18, 0x18, 0x24, 0x24, 0x24,
		0x24, 0x7e, 0x42, 0x42, 0x42, 0xe7, 0x00, 0x00
	};

	putfont8(binfo->vram, binfo->scrnx, 10, 10, COL8_FFFFFF, font_A);
}
void putfont8(char *vram, int xsize, int x, int y, char c, char *font)
{
	int i;
	char *p, d /* data */;
	for (i = 0; i < 16; i++) {
		p = vram + (y + i) * xsize + x;
		d = font[i];
		if ((d & 0x80) != 0) { p[0] = c; }
		if ((d & 0x40) != 0) { p[1] = c; }
		if ((d & 0x20) != 0) { p[2] = c; }
		if ((d & 0x10) != 0) { p[3] = c; }
		if ((d & 0x08) != 0) { p[4] = c; }
		if ((d & 0x04) != 0) { p[5] = c; }
		if ((d & 0x02) != 0) { p[6] = c; }
		if ((d & 0x01) != 0) { p[7] = c; }
	}
	return;
}
```

ä»¥ä¸Š font_A å­˜å‚¨äº† A å­—ç¬¦çš„ç‚¹é˜µä¿¡æ¯

<img src="./image_md/image-20230601113822518.png" alt="image-20230601113822518" style="zoom:25%;" />

```
// å¯¹ä»¥ä¸Šä»£ç è¿›è¡Œåˆ†æ
// 13è¡Œçš„forå°±æ˜¯å¾ªç¯ç‚¹é˜µæ¯ä¸€è¡Œ 16-23çš„åˆ¤æ–­å°±æ˜¯è¾“å‡ºæ¯ä¸€è¡Œä¸­çš„æ¯ä¸€åˆ—
// ä»¥ç¬¬ä¸‰è¡Œ 00011000ä¸ºä¾‹ æ­¤æ—¶dä¸º0x18 ä¹Ÿå°±æ˜¯00011000
16è¡Œ
00011000
10000000
-------- &
00000000
ä¸æ˜¾ç¤ºå­—ç¬¦

19è¡Œ
00011000
00010000
-------- &
00010000
æ˜¾ç¤ºå­—ç¬¦

ç”±æ­¤å¯çŸ¥
ä½¿ç”¨æŒ‰ä½é€’å‡çš„ä¸æ“ä½œï¼Œå¯ä»¥åˆ¤æ–­å‡ºdçš„æ¯ä¸€ä½æ˜¯ä¸æ˜¯1 ä»è€Œå†³å®šè¯¥åƒç´ æ˜¯å¦è¢«æ¸²æŸ“
```

è¿™é‡Œå°† A çš„å­—ç¬¦ç‚¹é˜µè¿›è¡Œä¿®æ”¹ å€’æ•°ç¬¬ä¸‰è¡Œå…¨éƒ¨æ¢æˆ 1

æ–°çš„ font_A

```c
static char font_A[16] = {
	0x00, 0x18, 0x18, 0x18, 0x18, 0x24, 0x24, 0x24,
	0x24, 0x7e, 0x42, 0x42, 0x42, 0xff, 0x00, 0x00
};
```

![image-20230601114415509](./image_md/image-20230601114415509.png)

åœ¨ç¬¬äº”å¤©æˆ‘ä»¬è¿˜ç ”ç©¶å‡ºå¦‚ä½•æ›´æ”¹å…¥å£å‡½æ•°

æ˜¯å¾ˆè¹©è„šçš„æ–¹æ³•ï¼Œä»…åœ¨è¿™é‡Œåšç®€å•è¯´æ˜ï¼Œæ²¡æœ‰æ‰¾åˆ°æ›´å¥½çš„åŠæ³•å‰ï¼Œè¿˜æ˜¯ä½¿ç”¨é»˜è®¤çš„å…¥å£å‡½æ•°

åœ¨ naskfunc.nas æ·»åŠ ä»¥ä¸‹è¯­å¥ï¼Œå£°æ˜åŸæœ¬çš„å…¥å£å‡½æ•°å è°ƒç”¨è‡ªå·±çš„å…¥å£å‡½æ•°åç§° æ ¹æ®æ±‡ç¼–è§„åˆ™å‰é¢åŠ \_

ä¸ºäº†é˜²æ­¢æŠ¥é”™ è¿˜è¦ EXTERN è¿™ä¸ªæ ‡è¯†ç¬¦ ä¹Ÿè¦æŠŠ HariMain æš´æ¼å‡ºå»

<img src="./image_md/image-20230601115109731.png" alt="image-20230601115109731" style="zoom:50%;" />

<img src="./image_md/image-20230601115005589.png" alt="image-20230601115005589" style="zoom:60%;" />

### ç¬¬å…­å¤©

ç¬¬å…­å¤©ä¸»è¦åšäº†æ–‡ä»¶åˆ†å‰²

å°† C è¯­è¨€åˆ†å‰²ä¸ºå¤šä¸ªå¸¦æºæ–‡ä»¶å’Œå¤´æ–‡ä»¶çš„æ–‡ä»¶

ç„¶ååšäº† PIC çš„åˆå§‹åŒ–å¯ä»¥æ¥æ”¶ä¸­æ–­

ç„¶åä½¿ç”¨æ ˆçš„æ•°æ®ç»“æ„åšäº† CPU ç°åœºä¿æŠ¤

å³éœ€è¦è°ƒç”¨ä¸­æ–­å¤„ç†ç¨‹åºå‰ï¼Œéœ€è¦ä¿å­˜ CPU å½“å‰å¯„å­˜å™¨çš„æ‰€æœ‰å€¼

è°ƒç”¨åæ¢å¤æ‰€æœ‰å€¼ CPU å›åˆ°æ­£å¸¸è¿è¡Œ

å…·ä½“åŸç†æœ‰äº›éš¾ è¿˜åœ¨ç ”è¯»ä¸­

![image-20230601120007632](./image_md/image-20230601120007632.png)

### ç¬¬ä¸ƒå¤©

ä¹¦æœ¬ 126 é¡µæœ‰å†™ 0x60+IRQ å·è¾“å‡ºç»™ OCW2 é‡å¯é”®ç›˜çš„ä¸­æ–­æ£€æµ‹

```C
void inthandler21(int *esp)
{
	unsigned char data;
	io_out8(PIC0_OCW2, 0x61); // é”®ç›˜æ˜¯IRQ1 é¼ æ ‡æ˜¯IRQ12
	data = io_in8(PORT_KEYDAT);
	fifo8_put(&keyfifo, data);
	return;
}

struct FIFO8 mousefifo;

void inthandler2c(int *esp)
/* PS/2ï¿½}ï¿½Eï¿½Xï¿½ï¿½ï¿½ï¿½ÌŠï¿½ï¿½èï¿½ï¿½ */
{
	unsigned char data;
	io_out8(PIC1_OCW2, 0x64);	// IRQ12ä½äºä»PICçš„ç¬¬å››ä¸ªåœ°å€
	io_out8(PIC0_OCW2, 0x62);	// é€šçŸ¥PIC0 IRQ2çš„å—ç†å®Œæˆ
	data = io_in8(PORT_KEYDAT);
	fifo8_put(&mousefifo, data);
	return;
}
```

harib04g æ–°å¢ä»£ç ä¸ºå¼€å¯é¼ æ ‡ç”µè·¯ æœ‰å…³é‡å¯ä¸­æ–­çš„è®²è§£ä¹Ÿåœ¨ä¸Šé¢å†™äº†

### ç¬¬å…«å¤©

é¼ æ ‡è§£è¯»ç®—æ³•ç”±äºæ˜¯å®šå¼ ä¸åšç»†è‡´ç ”ç©¶

è¿›å…¥ 32 ä½çš„ä»£ç  è¿˜æœ‰äº›ä¸æ˜ç™½ ä½†æ˜¯æš‚æ—¶ä¸å¿…æ·±ç©¶

ä¸»ç¨‹åºä¸­ åˆå§‹åŒ– gdt å’Œ pic åæ‰§è¡Œçš„ io_sti()æ˜¯ä¸ºäº†å›åº” asmhead.nas ä¸­çš„`ç¦æ­¢CPUä¸­æ–­`

### ç¬¬åå››å¤©

[CMOS - OSDev Wiki](https://wiki.osdev.org/CMOS)

å°è¯•å¼•å…¥äº† CMOS ç«¯å£

### ç¬¬åäº”å¤©

ä»»åŠ¡è°ƒåº¦

### ç¬¬åå…­å¤©

åé¢çš„ç®—æ³•æœ‰äº›æ²¡çœ‹æ‡‚ï¼Œå…ˆè·³è¿‡

### ç¬¬åä¸ƒå¤©

### ç¬¬åä¹å¤©

ç®—æ³•ä¸­å‡ºç°çš„ finfo æ˜¯æŒ‡æ•°æ®å¼€å§‹å­˜æ”¾çš„çš„åœ°å€ï¼Œx ä» 0 åˆ° 224 æ˜¯å› ä¸ºæ–‡ä»¶ä¿¡æ¯æœ€å­˜æ”¾ 224 ä¸ª

å¦‚æœ finfo çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º 0xe5 åˆ™ä»£è¡¨æ–‡ä»¶è¢«åˆ é™¤äº†ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º 0x00 ä»£è¡¨ä¸åŒ…å«ä»»ä½•æ–‡ä»¶åä¿¡æ¯ï¼Œtype ä¸­å­˜æ”¾å±æ€§

ä¸‹é¢å¯¹ hlt åº”ç”¨çš„ä»£ç æ³¨é‡Š

readfat å‡½æ•°å…¶å®æ˜¯è¯»å…¥çš„ fat è¡¨ è€Œä¸æ˜¯é•œåƒæ–‡ä»¶

fat è¡¨æœ‰ä¸¤ä»½ å…¶ä¸­ä¸€ä»½å°±æ˜¯ 0x000200 å¤„

é•œåƒçš„ 2600 å¤„å­˜æ”¾ç€æ–‡ä»¶åå­—ç­‰ä¿¡æ¯ ä¹Ÿå°±æ˜¯ finfo

FAT è¡¨å­˜æ”¾åœ¨ 0x000200 å¤„ å­˜æ”¾çš„æ˜¯æ–‡ä»¶ä¸‹ä¸€å—çš„ä½ç½®çš„ä¿¡æ¯

è¯»å–å¤§æ–‡ä»¶çš„æ—¶å€™é¦–å…ˆ finfo ä¸­çš„ clustno = 2 ç°‡å·æ˜¯ 2 æ ¹æ®ç°‡å·è®¡ç®—å‡ºæ–‡ä»¶ä½ç½®

ç„¶åæŸ¥æ‰¾ FAT è¡¨çš„ç¬¬ 2 é¡¹ è¿™é‡Œè®°å½•ç€ä¸‹ä¸€ä¸ªç°‡å·æ˜¯ 003 ç„¶å 3 å·è®°å½•ç€ 4 4 å·è®°å½•ç€ 5 ç›´åˆ°è¯»åˆ° FAT ä¸º FFF çš„è¡¨æ˜ç»“æŸäº†

FAT12 æ–‡ä»¶ç³»ç»Ÿ æ–‡ä»¶åéƒ½æ˜¯å¤§å†™

```C
else if (strcmp(cmdline, "hlt") == 0)
{
  /*å¯åŠ¨åº”ç”¨ç¨‹åºhlt.hrb */
  for (y = 0; y < 11; y++)
  {
    s[y] = ' ';
  }
  s[0] = 'H';
  s[1] = 'L';
  s[2] = 'T';
  s[8] = 'H';
  s[9] = 'R';
  s[10] = 'B';
  // 224æ˜¯å› ä¸ºæ–‡ä»¶ä¿¡æ¯æè¿°å—åªèƒ½å­˜224ä¸ªä¿¡æ¯
  for (x = 0; x < 224;)
  {
    // æ’é™¤ç©ºæ–‡ä»¶
    if (finfo[x].name[0] == 0x00)
    {
      break;
    }
    // 0x18
    // 00011000
    // æƒ³è¦å’Œ0x18ä¸è¿ç®—å¾—åˆ°0 é‚£ä¹ˆ typeç­‰äº
    // 00011000
    // xxx00xxx
    // ä¹Ÿå°±æ˜¯è¯´typeçš„ç¬¬å››ä½å’Œç¬¬äº”ä½å¿…é¡»æ˜¯0
    // è¯¾æœ¬è¯´ ä¸€èˆ¬çš„æ–‡ä»¶ä¸æ˜¯0x20å°±æ˜¯0x00 0x20æ˜¯00100000 ç¬¦åˆæ¡ä»¶
    if ((finfo[x].type & 0x18) == 0)
    {
      // æ¯”è¾ƒæ–‡ä»¶å
      for (y = 0; y < 11; y++)
      {
        if (finfo[x].name[y] != s[y])
        {
          goto hlt_next_file;
        }
      }
      break; /*æ‰¾åˆ°æ–‡ä»¶*/
    }
  hlt_next_file:
    x++;
  }
  // è¿è¡Œåˆ°æ­¤è¯´æ˜finfo[x]æ˜¯hlt.hrb
  if (x < 224 && finfo[x].name[0] != 0x00)
  {
    /*æ‰¾åˆ°æ–‡ä»¶çš„æƒ…å†µ*/
    // å¼€è¾Ÿå†…å­˜ç©ºé—´è½½å…¥ç¨‹åº
    p = (char *)memman_alloc_4k(memman, finfo[x].size);
    // è¯»å–ç£ç›˜æ–‡ä»¶åˆ°p
    file_loadfile(finfo[x].clustno, finfo[x].size, p, fat, (char *)(ADR_DISKIMG + 0x003e00));
    // è®¾ç½®æ®µå· æ®µå·1003ä¼šè®¿é—®åˆ°p
    set_segmdesc(gdt + 1003, finfo[x].size - 1, (int)p, AR_CODE32_ER);
    // è·³è½¬åˆ°æ®µå·1003
    farjmp(0, 1003 * 8);
    memman_free_4k(memman, (int)p, finfo[x].size);
  }
  else
  {
    /*æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶çš„æƒ…å†µ*/
    putfonts8_asc_sht(sheet, 8, cursor_y, COL8_FFFFFF, COL8_000000, "File not found.", 15);
    cursor_y = cons_newline(cursor_y, sheet);
  }
  cursor_y = cons_newline(cursor_y, sheet);
}
```
